= パイプラインによる自動化
:navtitle: パイプラインによる自動化

include::vars.adoc[]

OpenShiftに組み込まれたコンポーネントに加え、OpenShift Pipelinesは link:https://tekton.dev/docs/triggers/[*Tekton Triggers*,window='_blank'] のおかげで、パイプラインに追加のトリガーと自動化を提供します。

[#webhooks]
== 背景: Webフック

ほとんどのGitリポジトリサーバーはWebフックの概念をサポートしています -- コードリポジトリで変更が発生したときに、HTTP(S)経由で外部ソースを呼び出すことです。
OpenShiftは、ビルドをトリガーするためにリモートシステムからフックを受信することをサポートするAPIエンドポイントを提供します。
コードリポジトリのフックをOpenShift Pipelinesのリソースに向けることで、自動化されたコード/ビルド/デプロイのパイプラインを実現できます。

[#adding_triggers_to_your_pipeline]
== パイプラインへのトリガーの追加

Tekton *Triggers* により、Webフックなどの外部イベント（Gitのプッシュイベント、プルリクエストなど）に応答するようにパイプラインを設定できます。
トリガーサポートを追加するには、プロジェクトに `TriggerTemplate`、`TriggerBinding`、および `EventListener` を作成する必要があります。

[.bordershadow]
image::devops-pipeline-triggers.png[link="self",window=_blank]

各コンポーネントを詳しく見てみましょう：

* *TriggerTemplate*: トリガーテンプレートは、新しく作成されるリソースのテンプレートです。
特定の `PipelineResources` や `PipelineRuns` を作成するためのパラメータをサポートします。
* *TriggerBinding*: イベントを検証し、ペイロードフィールドを抽出します。
* *EventListener*: `TriggerBindings` と `TriggerTemplates` をアドレス可能なエンドポイント（イベントシンク）に接続します。
各TriggerBindingから抽出されたイベントパラメータ（および提供された静的パラメータ）を使用して、対応するTriggerTemplateで指定されたリソースを作成します。
オプションで、インターセプターフィールドを介して外部サービスがイベントペイロードを前処理することもできます。

では、私たちのパイプラインのためにこれらすべてを一緒に作成しましょう。
// どの言語を選択したかに応じて、以下のYAMLファイルを使用できます：

// ====
// *Java*

[source,role="copypaste",subs="attributes"]
----
oc create -f {ocp4_starter_gitea_url}/{ocp4_starter_gitea_user}/nationalparks/raw/branch/master/pipeline/nationalparks-triggers.yaml -n {ocp4_starter_project}
----

// *.NET*

// [source,role="copypaste",subs="attributes"]
// ----
// oc create -f {ocp4_starter_gitea_url}/{ocp4_starter_gitea_user}/nationalparks-dotnet/master/Pipelines/nationalparks-triggers-all.yaml -n {ocp4_starter_project}
// ----

// *Javascript*:

// [source,role="copypaste",subs="attributes"]
// ----
// oc create -f {ocp4_starter_gitea_url}/{ocp4_starter_gitea_user}/nationalparks-js/master/pipelines/nationalparks-triggers-all.yaml -n {ocp4_starter_project}
// ----

// *Python*

// [source,role="copypaste",subs="attributes"]
// ----
// oc create -f {ocp4_starter_gitea_url}/{ocp4_starter_gitea_user}/nationalparks-py/master/pipelines/nationalparks-triggers-all.yaml -n {ocp4_starter_project}
// ----
// ====

これにより、パイプラインの自動開始をトリガーするためにGitHubでWebhookを設定するために使用できる、Route（ルート）を持つ新しいPodが作成されます。
*Topology*（トポロジー）ビューで、`EventListener` のための新しいデプロイメント *el-nationalparks* が作成されたか確認してください：

[.bordershadow]
image::devops-pipeline-triggers-eventlistener.png[width=500,link="self",window=_blank]

[#configuring_webhooks]
== 演習: Gitea Webフックの設定

このセクションでは、ビルドWebフックを使用して、nationalparksのGiteaリポジトリに変更があるたびにパイプラインの実行をトリガーできます。
URLをクリップボードにコピーしたら、Gitea上にあるコードリポジトリに移動します：

link:{ocp4_starter_gitea_url}/{ocp4_starter_gitea_user}/nationalparks[Giteaリポジトリ,window='_blank']

画面右上のボタンを使用してサインインします。
Giteaの認証情報は次のとおりです：

[source,subs=attributes]
----
username: {ocp4_starter_gitea_user}
password: {ocp4_starter_gitea_password}
----

画面右上のSettings（設定）リンクをクリックします：

[.bordershadow]
image::nationalparks-codechanges-settings.png[link="self",window=_blank]

*Webhooks*（Webフック）をクリックし、次に *Add Webhook*（Webフックの追加）ボタンをクリックし、最後に *Gitea* を選択します。
[.bordershadow]
image::nationalparks-codechanges-add-webhook.png[link="self",window=_blank]

前のセクションで作成したEventListenerを使用して、GiteaでWebhookを設定します。
`EventListener` はOpenShiftの `Route`（ルート）を公開しており、これをWebhookのURLとして使用します。
[source,role=copypaste,subs=attributes]
----
http://el-nationalparks-{ocp4_starter_project}.{ocp4_starter_apps_domain}/
----

リンクを「Payload URL」フィールドに貼り付けます。

`Content Type`（コンテンツタイプ）を `application/json` に変更します。

最後に、*Update Webhook*（Webhookの更新）をクリックします。

[.bordershadow]
image::nationalparks-codechanges-config-webhook.png[link="self",window=_blank]

これで完了です！
これからは、Giteaリポジトリに新しいソースコードをコミットするたびに、OpenShift内で新しいビルドとデプロイが発生します。
これを試してみましょう。

[#using_webhooks]
== 演習: Gitea Webフックの使用

次に、Giteaを使用してファイルを編集し、変更をコミットしてプッシュします。
`BackendController.java` ファイル link:{ocp4_starter_gitea_url}/{ocp4_starter_gitea_user}/nationalparks/src/branch/master/src/main/java/com/openshift/evg/roadshow/parks/rest[をGiteaリポジトリのここで開きます,window='_blank']。
ブラウザにコピー＆ペーストしたい場合、URLの場所は次のとおりです：

[source,role="copypaste",subs="attributes"]
----
{ocp4_starter_gitea_url}/{ocp4_starter_gitea_user}/nationalparks/src/branch/master/src/main/java/com/openshift/evg/roadshow/parks/rest
----

ファイルが画面に表示されたら、図のように右上隅の編集ボタンをクリックします：

image::nationalparks-codechanges-change-code.png[Webhook]

20行目を変更します：

[source]
----
return new Backend("nationalparks","National Parks", new Coordinates("47.039304", "14.505178"), 4);
----

これを以下に変更します：

[source,role="copypaste"]
----
return new Backend("nationalparks","Amazing National Parks", new Coordinates("47.039304", "14.505178"), 4);
----

画面下部の *Commit changes*（変更をコミット）をクリックします。
コミットメッセージは自由に入力してください。

変更をコミットすると、新しい *PipelineRun* が自動的にトリガーされるはずです。
前の演習でPipelineRunを見ましたね。これは新しい *Build*（ビルド）を作成し、アプリケーションをOpenShiftにデプロイします。
これを確認しましょう！

*Topology*（トポロジー）ビューから `nationalparks` をクリックし、*Resources*（リソース）タブの *Builds*（ビルド）セクションを見るか、または
次のコマンドを実行して確認します：

[source,role="copypaste"]
----
oc get builds
----

新しいビルドが実行中であることがわかるはずです：

[.console-output]
[source]
----
NAME              TYPE      FROM          STATUS     STARTED          DURATION
nationalparks-1   Source    Git@b052ae6   Complete   18 hours ago     36s
nationalparks-2   Source    Git@3b26e1a   Running    43 seconds ago
----

ビルドとデプロイが完了したら、ブラウザでアプリケーションを表示して、新しいイメージが
自動的にデプロイされたことを確認します：

link:http://nationalparks-{ocp4_starter_project}.{ocp4_starter_apps_domain}/ws/info/[National Parks情報ページ,window='_blank']

これで、返されたJSON文字列に設定した新しい名前が表示されるはずです。
NOTE: これをマップの凡例自体に表示するには、parksmapを0にスケールダウンしてから1に戻し、アプリにキャッシュを強制的に更新させる必要があります。
