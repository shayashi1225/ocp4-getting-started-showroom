= MLBParksアプリ
:navtitle: MLBParksアプリ

include::vars.adoc[]

このラボでは、REST APIバックエンドとMongoDBデータベースで構成される、完全なバックエンドアプリケーションをデプロイします。
この完全なアプリケーションは、すでに相互に連携（wired together）され、マップ可視化ツールのバックエンドとして記述されています。そのため、アプリケーションがビルドおよびデプロイされると、新しいマップが表示されるようになります。

image::deprecated/roadshow-app-architecture-mlbparks.png[アプリケーション アーキテクチャ,800,align="center"]

これまでのいくつかのラボで実行したすべての演習を、単一のコマンドでインスタンス化できる*テンプレート*を使用して組み合わせてみましょう。
今日のワークショップですべてをデプロイするためにテンプレートを使用することもできましたが、リソースを作成し、デプロイし、相互に連携させる方法を理解することが重要であることを覚えておいてください。

[#instantiate_template]
== 演習: テンプレートのインスタンス化

私たちがこれまでずっと作業してきたフロントエンドアプリケーションは、作成された数だけバックエンドサービスのデータを表示します。
適切な*ラベル*（Label）を付けてアイテムを追加すると、マップ上にさらに多くのアイテムが表示されるようになります。

ここでは、テンプレートを使用して、米国のメジャーリーグベースボールスタジアムのマップをデプロイします。
これは、バックエンドのJavaアプリケーションをビルドし、MongoDBデータベースをデプロイするように事前設定されています。
また、*フック*（Hook）を使用して `/ws/data/load` エンドポイントを呼び出し、ソースコードリポジトリ内のJSONファイルからデータベースにデータがロードされるようになっています。

以下のコマンドを実行します：

[.console-input]
[source,bash,subs="+attributes"]
----
oc create -f https://raw.githubusercontent.com/openshift-roadshow/mlbparks/master/ose3/application-template-eap.json -n {ocp4_starter_project}
----

何が起こったのでしょうか？ 何を `create`（作成）したのでしょうか？
`create` コマンドに渡したアイテムは*テンプレート*です。 `create` は、単にテンプレートを*プロジェクト*（Project）で利用可能にするだけです。
これは、次のコマンドで確認できます：

[.console-input]
[source,bash,subs="+attributes,macros+"]
----
oc get template
----

以下のような出力が表示されます：

[.console-output]
[source,bash]
----
mlbparks      Application template MLBParks backend running on Wildfly and using mongodb   12 (2 blank)   8
----

次のコマンドを実行して、テンプレートをインスタンス化します：

[.console-input]
[source,bash,subs="+attributes,macros+"]
----
oc new-app mlbparks -p APPLICATION_NAME=mlbparks
----

このような出力が表示されます：

[.console-output]
[source,bash]
----
--> Deploying template "workshop/mlbparks" to project workshop

     MLBparks
     ---------
     Application template MLBParks backend running on Wildfly and using mongodb

     * With parameters:
       * アプリケーション名=mlbparks
       * アプリケーション ルート=
       * Mongodb アプリ=mongodb-mlbparks
       * Gitソースリポジトリ=https://github.com/openshift-roadshow/mlbparks.git
       * Gitブランチ/タグ リファレンス=master
       * MavenミラーURL=
       * データベース名=mongodb
       * データベース ユーザー名=userW3n # 生成済み
       * データベース ユーザー パスワード=4PmSfXWL # 生成済み
       * データベース 管理者パスワード=cBQ4RGJf # 生成済み
       * GitHubトリガー=TOR1p3wO # 生成済み
       * 汎用トリガー=NUlqyK54 # 生成済み

--> リソースを作成中 ...
    configmap "mlbparks" が作成されました
    service "mongodb-mlbparks" が作成されました
    deploymentconfig.apps.openshift.io "mongodb-mlbparks" が作成されました
    imagestream.image.openshift.io "mlbparks" が作成されました
    buildconfig.build.openshift.io "mlbparks" が作成されました
    deploymentconfig.apps.openshift.io "mlbparks" が作成されました
    service "mlbparks" が作成されました
    route.route.openshift.io "mlbparks" が作成されました
--> Succeeded
    ビルドがスケジュールされました。 'oc logs -f bc/mlbparks' を使用して進捗を追跡してください。
    ルート 'mlbparks-workshop.apps.cluster-1d43.1d43.openshiftworkshop.com' 経由でアプリケーションにアクセスしてください。
    'oc status' を実行してアプリのステータスを表示してください。
----

これにより、OpenShiftは以下を実行します：

* ビルドを設定して開始します
** （パラメータを指定した場合）提供されたMavenミラーURLを使用します
** 提供されたソースコードリポジトリから
* MongoDBを設定してデプロイします
** 自動生成されたユーザー、パスワード、データベース名を使用します
* アプリがDBに接続するための環境変数を設定します
* 適切なServiceを作成します
* アプリのServiceに `type=parksmap-backend` というラベルを付けます

すべてを1つのコマンドで！
ビルドが完了したら、parks mapにアクセスしてください。動作しますか？
これがあなたの環境でどのように使用できるか考えてみてください。例えば、テンプレートは、複数のアプリサーバー、データベースなどを含む「リファレンスアプリケーション」を構成する大規模なリソースセットを定義できます。
1つのコマンドでリソースセット全体をデプロイし、その後それらを変更（hack）して、新機能の開発、マイクロサービスの追加、バグ修正などを行うことができます。

TIP: アプリがすでに `workshop` アプリケーショングループ内にあり、EAPとMongoDBの素敵なアイコンが付いていることにお気づきでしょう。これは、テンプレートが両方のDeploymentConfigにすでに設定していた `app.kubernetes.io/part-of` と `app.kubernetes.io/name` ラベルのおかげです。

image::deprecated/mlbparks-templates-complete-overview.png[全体の概要]

上記のようにコマンドラインからテンプレートをインスタンス化できるだけでなく、WebコンソールのDeveloperパースペクティブからもテンプレートをインスタンス化できます。
*+Add*（追加）をクリックし、次に *From Catalog*（カタログから）をクリックして `mlb` を検索します。 `MLBparks` の結果が表示されるはずです。

image::deprecated/mlbparks-templates-dev-catalog.png[Developerカタログ内のテンプレート]

`MLBparks` をクリックし、*Instantiate Template*（テンプレートのインスタンス化）ボタンをクリックすると、このテンプレートのインスタンス化に必要な様々な必須およびオプションのパラメータを案内するフォームが表示されます。
CAUTION: すでにコマンドラインからテンプレートをインスタンス化しているため、今はWebコンソールからインスタンス化しないでください。

最後の演習として、 *mlbparks* アプリケーションのリソースを作成するために使用されたテンプレートを見てみましょう。

[.console-input]
[source,bash,subs="+attributes,macros+"]
----
oc get template mlbparks -o yaml
----

しかし、いつものように、OpenShift Webコンソールを使っても同じことができます。
Developerパースペクティブで、左側のナビゲーションから *Advanced -> Search*（高度な検索 -> 検索）をクリックし、ドロップダウンから *Template*（テンプレート）を選択し、 *mlbparks* をクリックします。

image::deprecated/mlbparks-templates-yaml-menu.png[全体の概要]

次のページで *YAML* をクリックすると、ここからYAMLを表示/編集できます。

image::deprecated/mlbparks-templates-yaml-edit.png[テンプレートYAMLの編集]
