= アプリのデバッグ
:navtitle: アプリのデバッグ

include::vars.adoc[]


[#port_forwading_and_debugging]
== 背景: ポートフォワーディングとデバッグ
以前にPodにリモートシェルで接続したのと同様に、ローカルマシンとPod間にポートフォワード（port-forward）を設定することもできます。
これは、Podで実行中のデータベースへの接続、公開したくない管理用Webインターフェースの表示、あるいは（今回の場合）アプリケーションサーバーを実行しているJVMへのデバッガーのアタッチといった操作に役立ちます。
アプリケーションサーバーのデバッグポートをポートフォワーディングすることで、IDEからデバッガーをアタッチし、Pod内でリアルタイムに実行されているコードを実際にステップ実行できます。
デフォルトではEAPはデバッグモードになっていないため、まずデバッグポートを有効にする必要があります。

[#enabling_debugging_in_eap_on_openshift]
== 演習: OpenShift上のEAPでデバッグを有効にする

デバッグを有効にするのは非常に簡単です。
私たちが使用しているEAP S2Iコンテナは、デバッグポートを有効にするかどうかを制御するための環境変数を探します。
必要なのは、デプロイメント（deployment）に環境変数を設定することだけです。
[source,bash,role=copypaste]
----
oc set env dc/mlbparks DEBUG=true
----

これによりMLBparks Podが強制的に再デプロイされ、今度はJDWTトランスポートが有効になり、ポート8787で待機（serving）するようになります。

Podに直接接続してデバッグすることもできますが、Podのインスタンスが1つしか実行されていない場合は、Serviceを介してポートフォワーディングを設定すると便利です（Pod名は変わりますが、Serviceの名前は静的（static）であるため）。
<<Exercise: Port-Forwarding from the pod to our local machine,演習: Podからローカルマシンへのポートフォワーディング>> を参照してください。

[#port-forwarding_from_svc_to_our_local_machine]
== Serviceを介したローカルマシンへのポートフォワーディング

問題のServiceを詳しく見てみましょう：

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc describe svc/mlbparks
----

[.console-output]
[source,bash,subs="+macros,+attributes"]
----
Name:              mlbparks
Namespace:         workshop
Labels:            app=workshop
                   component=mlbparks
                   createdBy=mlbparks-template
                   role=backend
                   type=parksmap-backend
Annotations:       openshift.io/generated-by: OpenShiftNewApp
                   service.alpha.openshift.io/dependencies: [{"name":"mongodb-mlbparks","namespace":"","kind":"Service"}]
Selector:          deploymentConfig=mlbparks
Type:              ClusterIP
IP Families:       <none>
IP:                172.21.206.162
IPs:               <none>
Port:              8080-tcp  8080/TCP
TargetPort:        8080/TCP
Endpoints:         172.30.18.203:8080
Port:              8787-tcp  8787/TCP
TargetPort:        8787/TCP
Endpoints:         172.30.18.203:8787
Session Affinity:  None
Events:            <none>
----

デプロイメントがデバッグ用にセットアップされたので、ポート8787でリッスン（listening）しています。Serviceのそのポート（訳注：8787）へのポートフォワーディングを設定します（これにより、ServiceはPodへと転送します）。

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc port-forward svc/mlbparks 8787:8787
----

これで、 `localhost:8787` に接続すると、Podで実行されているmlbparksインスタンスに転送（forward）されます。
NOTE: ポートフォワーディングは、 `oc port-forward` コマンドの実行が許可されている間だけアクティブです。
フォアグラウンドで実行しているため、 kbd:[CTRL+c] （Macの場合は kbd:[CMD+c] ）を押すことでポートフォワーディングを停止できます。

あとは、そのポートに接続するデバッガーを見つけるだけです。

[#setting_up_remote_debugging]
== リモートデバッガーのアタッチ

ソースコードをデバッグするには、お好みのIDE（IntelliJの手順は以下）を使用するか、コンソールからデバッグすることができます。
状況に応じて適切なタブを選択してください。

[tabs]
====
コンソール::
+
--

.NOTE
****
これは、Javaコマンドラインデバッガーである `jdb` がインストールされていることを前提としています。
インストールされていない場合は、 xref::mlbparks-binary-build.adoc#docker_for_maven[こちらの手順] を参照して、Mavenと `jdb` がインストールされたDockerコンテナを実行してください。
これらの手順を完了したら、コンテナ内から <<Port-Forwarding through a Service to our local machine,上記>> で説明したようにポートフォワーディングを設定します。
その後、コンテナ内から以下の手順に従います。
****

.
ローカルにクローンしたmlbparksのGitリポジトリのルートから、次のコマンドを実行します：
+
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
jdb -sourcepath $(pwd)/src/main/java -attach localhost:8787
----
+
[.console-output]
[source,bash,subs="+macros,+attributes"]
----
Set uncaught java.lang.Throwable
Set deferred uncaught java.lang.Throwable
Initializing jdb ...
> 
----
+
.
次に、デバッガーでこのコマンドを発行して、 `BackendController` クラスにブレークポイントを設定します：
+
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
stop in com.openshift.evg.roadshow.rest.BackendController.get
----
+
[.console-output]
[source,bash,subs="+macros,+attributes"]
----
Set breakpoint com.openshift.evg.roadshow.rest.BackendController.get
----
+
.
mlbparksのURLに移動します（シェルからcurlを使用するか、ブラウザにURLを貼り付けます）
+
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
curl http://mlbparks-workshop.{ocp4_starter_apps_domain}/ws/info
----
+
.
デバッガーが `BackendController.get` メソッドの最初の行で「ブレーク」（停止）するはずです
+
[.console-output]
[source,java,subs="+macros,+attributes"]
----
Breakpoint hit: "thread=default task-4", com.openshift.evg.roadshow.rest.BackendController.get(), line=23 bci=0
23            return new Backend("mlbparks", "AMAZING MLB Parks", new Coordinates("39.82", "-98.57"), 5);
----
+
. jdbコマンドを自由にいじってみてください。
例としては以下が含まれます：
** `list`: ブレークポイント周辺のソースをより広く表示します
** `where`: スレッドの現在のスタックをダンプします
** `print`: 変数の値を表示します。例えば `print this` でBackendControllerを文字列として表示します
** `cont`: プログラムの実行を継続します
--
IntelliJ::
+
--
IntelliJでのリモートデバッグの設定は非常に簡単です。
まず、実行/デバッグ構成を編集します。Runメニュー（ kbd:[ALT + u] ）から、edit configurationsを選択します。
これにより、新しい構成ダイアログが表示されます。

左上隅のプラスをクリックし、下にスクロールして、Remote JVM Debugを選択します。
image::deprecated/mlbparks-debugging-intellij-debug-new.png[IntelliJ New Configuration]

表示されたダイアログページで、上部の名前を「on OpenShift」など、分かりやすいものに変更します。
次に、右下に向かってポート番号を8787に変更します。それが完了したら「OK」をクリックします。
image::deprecated/mlbparks-debugging-intellij-debug-info.png[IntelliJ New Configuration]

これで、IntelliJでデバッグアイコンをクリックすると、デバッガーが開き、OpenShift上のPod内のJVMにアタッチされます。
好きなクラスにブレークポイントを設定すれば、お馴染みの通常のデバッグが行えます！
--
====

[#port-forwarding_from_pod_to_our_local_machine]
== 演習: Podからローカルマシンへのポートフォワーディング

ポートフォワーディングを行うのは非常に簡単です。
まずPodを取得します：
[source,bash,role=copypaste]
----
oc get pods
----

[.console-output]
[source,bash]
----
NAME                             READY   STATUS      RESTARTS   AGE
mlbparks-1-build                 0/1     Completed   0          4d
mlbparks-1-deploy                0/1     Completed   0          4d
mlbparks-1-hook-post             0/1     Completed   0          4d
mlbparks-2-build                 0/1     Completed   0          10m
mlbparks-2-deploy                0/1     Completed   0          9m49s
mlbparks-2-hook-post             0/1     Completed   0          8m59s
mlbparks-3-deploy                1/1     Running     0          25s
mlbparks-3-hcd8g                 0/1     Running     0          10s
...
----

では、ポートフォワードを設定しましょう：

[.console-input]
[source,bash,subs="+attributes,macros+"]
----
oc port-forward mlbparks-3-hcd8g 8787:8787
----

Podのポート8787からローカルマシンの8787にポートフォワードするように指定しました。
これで、 <<Attaching a Remote Debugger,ここ>> で概説されているようにリモートデバッガーをアタッチできます。