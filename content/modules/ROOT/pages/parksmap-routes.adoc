= Route（ルート）
:navtitle: Route（ルート）

include::vars.adoc[]

このワークショップセクションでは、アプリケーションを外部ユーザーから
アクセス可能にします。

[.bordershadow]
image::roadshow-app-architecture-parksmap-2.png[link="self",window=_blank]

[#routes]
== 背景: Route（ルート）

*Service*（サービス）は、OpenShift環境内で
内部的な抽象化とロードバランシングを提供しますが、
OpenShiftの **外部** にいるクライアント（ユーザー、システム、デバイスなど）が
アプリケーションにアクセスする必要がある場合もあります。
外部クライアントは、
*Route*（ルート）オブジェクトを使用して設定できるOpenShiftルーティングレイヤーを通じて、
OpenShiftで実行されているアプリケーションにアクセスします。
デフォルトのOpenShiftルーター（https://www.haproxy.org/[HAProxy, window="_blank"]）は、
受信リクエストのHTTPヘッダーを使用して、
接続をプロキシする場所を決定します。 オプションで、
*Route* にTLSなどのセキュリティを定義できます。
*Service*、ひいては *Pod*（ポッド）を
外部の世界からアクセス可能にしたい場合は、
*Route* を作成する必要があります。

[#creating_a_route]
== 演習: Routeの作成

`parksmap` アプリケーションをデプロイしたときに、*Route* を
作成するためのチェックボックスをオフにしたことを覚えているかもしれません。
通常、それは自動的に作成されていたでしょう。
幸い、*Route* の作成は簡単なプロセスです。
OpenShiftコンソールから、または `oc` CLIを使用してRouteを作成できます。
以下のオプションのいずれかを使用して、
ルートを追加するためのお好みの方法を選択してください。

====
*オプションA: OpenShift Console:*

.
 *Networking -> Routes*（ネットワーキング -> ルート）をクリックし、*Create Route*（ルートの作成）ボタンをクリックします。
. *Name*（名前）フィールドに *parksmap* と入力します。
.
 *Service*（サービス）フィールドから *parksmap* を選択します。*Target Port*（ターゲットポート）で、*8080* を選択します。
. *Security*（セキュリティ）セクションで、*Secure route*（セキュア ルート）をチェックします。
*TLS Termination*（TLS終端）リストから *Edge*（エッジ）を選択します。
. 他のすべてのフィールドは空白のままにして、*Create*（作成）をクリックします：
+
image::parksmap-route-create-1.png[link="self",window=_blank]

TIP: クラスターAppsドメインのTLS証明書がデフォルトで使用されるため、
証明書を追加する必要はありません。
OpenShiftクラスターに解決されるカスタムドメインを使用したい場合は、
ルートごとに証明書を追加できます。
*Route* を作成する際、
*Route* のホスト名やパス、
追加のTLS設定など、他のオプションを指定できます。

*オプションB: `oc` Command Line:*

*Service* を `expose`（公開）するために、
まず既存の *Route* がないことを確認します：

[source,role="copypaste"]
----
oc get routes
----

[.console-output]
[source]
----
No resources found.
 ----

次に、公開する *Service* 名を取得する必要があります：

[source,role="copypaste"]
----
oc get services
----

[.console-output]
[source]
----
NAME       CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
parksmap   172.30.169.213   <none>        8080/TCP   5h
----

*Service* 名がわかったら、*Route* の作成は
簡単な1コマンドのタスクです：

[source,role="copypaste"]
----
oc create route edge parksmap --service=parksmap
----

[.console-output]
[source]
----
route.route.openshift.io/parksmap created
----

====

次のコマンドで *Route* が作成されたことを確認します：

[source,role="copypaste"]
----
oc get route
----

[source,role="copypaste",subs="attributes"]
----
NAME       HOST/PORT               
                                             PATH   SERVICES   PORT       TERMINATION   WILDCARD
parksmap   parksmap-{ocp4_starter_project}.{ocp4_starter_apps_domain}          parksmap   8080-tcp   edge          None
----

*Topology*（トポロジー）ビューで、
`parksmap` Deployment（デプロイメント）の *Resources*（リソース）タブの下でも *Route* を確認できます。
Topology（トポロジー）の `parksmap` ノードに矢印アイコンが表示されるようになりました。
それをクリックすると、*Route* のURLがブラウザで開きます。

[.bordershadow]
image::parksmap-route-created.png[link="self",window=_blank]

アプリケーションは、Developer Perspective（開発者パースペクティブ）に表示されるURLで
利用可能になりました。 リンクをクリックすると、それが表示されます。

NOTE: このページを初めて開く場合、
ブラウザはあなたの位置情報を取得する許可を求めます。
これは、フロントエンドアプリが