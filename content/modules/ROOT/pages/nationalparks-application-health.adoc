= アプリケーションのヘルスチェック
:navtitle: アプリケーションのヘルスチェック

include::vars.adoc[]

== 背景: ReadinessプローブとLivenessプローブ
以前にUIの警告で見たように、OpenShiftにはアプリケーションのヘルスチェックという概念があります。
これらには2つの種類があります：

* Readinessプローブ (準備完了プローブ)
* Livenessプローブ (生存プローブ)

ドキュメントの link:{ocp4_starter_openshift_docs}/html/building_applications/application-health[アプリケーションヘルス,window='_blank'] のセクションから、定義を見てみましょう：

[glossary]
Liveness Probe::
  Livenessプローブは、それが設定されているコンテナがまだ実行中かどうかをチェックします。
  Livenessプローブが失敗すると、kubeletはそのコンテナを強制終了（kill）し、コンテナは再起動ポリシーの対象となります。
  Pod設定の `template.spec.containers.livenessprobe` スタンザ（stanza）を設定することで、Livenessチェックを設定します。
Readiness Probe::
  Readinessプローブは、コンテナがリクエストを処理（service）する準備ができているかどうかを判断します。
  Readinessプローブがコンテナで失敗した場合、エンドポイントコントローラーは、そのコンテナのIPアドレスがすべてのServiceのエンドポイントから削除されるようにします。
  Readinessプローブは、コンテナが実行中であっても、プロキシからトラフィックを受信すべきではないことをエンドポイントコントローラーに通知するために使用できます。
  Pod設定の `template.spec.containers.readinessprobe` スタンザを設定することで、Readinessチェックを設定します。

複雑に聞こえますが、実際はそうではありません。Webコンソールを使用して、これらのプローブを `nationalparks` アプリケーションに追加します。

[#add_health_checks]
== 演習: ヘルスチェックの追加
現実的なCI/CDパイプラインを実装していくにあたり、アプリケーションの「開発（development）」バージョンのテストをいくつか行うことになります。
しかし、アプリをテストするためには、準備ができていなければなりません。ここでOpenShiftのアプリケーションヘルス機能が非常に役立ちます。
既存の `nationalparks` デプロイメントに、ReadinessプローブとLivenessプローブの両方を追加します。
これにより、OpenShiftはReadinessチェックに合格するまでインスタンスをServiceに追加せず、不健康なインスタンス（Livenessチェックに失敗した場合）は再起動されるようになります。

*Topology*（トポロジー）ビューから、`nationalparks` をクリックします。サイドパネルで、*Actions*（アクション）ドロップダウンメニューをクリックし、*Add Health Checks*（ヘルスチェックの追加）を選択します。

[.bordershadow]
image::nationalparks-application-health-menu.png[link="self",window=_blank]

*Add Readiness Probe*（Readinessプローブの追加）をクリックし、*Path*（パス）フィールドに以下を追加します：

[source,role=copypaste]
----
/ws/healthz/
----

*Port*（ポート）8080や*Type*（タイプ）HTTP GETなど、すべてのデフォルト設定はそのままにします。
右下の小さな灰色の確認チェックマークをクリックして確認します：

[.bordershadow]
image::nationalparks-application-health-settings.png[link="self",window=_blank]

Livenessプローブについても同じ手順を繰り返し、*Add Liveness Probe*（Livenessプローブの追加）をクリックし、*Path*（パス）フィールドに以下を追加します：

[source,role=copypaste]
----
/ws/healthz/
----

*Port*（ポート）8080や*Type*（タイプ）HTTP GETなど、すべてのデフォルト設定はそのままにします。
右下の小さな灰色の確認チェックマークをクリックして確認します。

最後に *Add*（追加）をクリックして、すべての新しい変更を確定します：

[.bordershadow]
image::nationalparks-application-health-add.png[link="self",window=_blank]


これらの変更が新しいデプロイメントを引き起こしたことに気づくでしょう -- これらは設定変更としてカウントされたためです。